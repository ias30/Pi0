# âœ… Realmanå®æ—¶æ¨ç†ä¿®å¤éªŒè¯æŒ‡å—

## ğŸ“‹ ä¿®æ”¹æ€»ç»“

### å·²ä¿®æ”¹çš„æ–‡ä»¶
1. âœ… `examples/realman_inference.py` - ä¸»è¦å®æ—¶æ¨ç†è„šæœ¬
2. âœ… `examples/compare_offline_realtime_observation.py` - å¯¹æ¯”éªŒè¯å·¥å…·

### æ ¸å¿ƒä¿®æ”¹

#### ä¿®å¤1ï¼šåˆ é™¤åŒé‡å½’ä¸€åŒ–é—®é¢˜
- ä¿®æ”¹å‰ï¼šå›¾åƒåœ¨ `preprocess_image()` ä¸­å½’ä¸€åŒ–åˆ° [-1,1]ï¼Œç„¶å transform pipeline å†æ¬¡å½’ä¸€åŒ–
- ä¿®æ”¹åï¼š`preprocess_image()` åªåšæ ¼å¼è½¬æ¢ï¼Œå½’ä¸€åŒ–äº¤ç»™ transform pipeline ç»Ÿä¸€å¤„ç†

#### ä¿®å¤2ï¼šæ·»åŠ  Tensor åˆ° numpy è½¬æ¢
- é—®é¢˜ï¼šå¯¹æ¯”å·¥å…·ä» LeRobot æ•°æ®é›†åŠ è½½çš„æ˜¯ PyTorch Tensorï¼Œéœ€è¦è½¬æ¢ä¸º numpy array
- è§£å†³ï¼šåœ¨ `create_realtime_frame()` ä¸­æ·»åŠ äº†è‡ªåŠ¨æ£€æµ‹å’Œè½¬æ¢é€»è¾‘

---

## ğŸ§ª éªŒè¯æ­¥éª¤

### æ–¹æ³•1ï¼šä½¿ç”¨å¯¹æ¯”å·¥å…·éªŒè¯ï¼ˆæ¨èï¼‰

è¿™ä¸ªå·¥å…·ä¼šå¯¹æ¯”ç¦»çº¿æ¨ç†å’Œå®æ—¶æ¨ç†çš„æ•°æ®å¤„ç†æ˜¯å¦ä¸€è‡´ã€‚

```bash
cd /home/ren9/DualArm/openpi

python examples/compare_offline_realtime_observation.py \
    --config-name pi0_realman \
    --checkpoint checkpoints/pi0_realman/realman_finetune_v1/14999 \
    --dataset-path ~/.cache/huggingface/lerobot/realman_dataset \
    --norm-stats assets/pi0_realman/realman_dataset/ \
    --episode 0 \
    --frame-index 10
```

#### é¢„æœŸè¾“å‡º

âœ… **æˆåŠŸçš„æ ‡å¿—**ï¼š
```
======================================================================
COMPARING OBSERVATIONS
======================================================================

======================================================================
Comparing: state
======================================================================
  Shape (offline):   (1, 12)
  Shape (realtime):  (1, 12)
  âœ… Shapes match
  
  âœ… VALUES MATCH (rtol=1e-05, atol=1e-08)

======================================================================
Comparing: images.cam_high
======================================================================
  Shape (offline):   (1, 3, 224, 224)
  Shape (realtime):  (1, 3, 224, 224)
  âœ… Shapes match
  
  âœ… VALUES MATCH (rtol=1e-05, atol=1e-08)

[... å…¶ä»–ç›¸æœºçš„ç±»ä¼¼è¾“å‡º ...]

======================================================================
ğŸ“Š å¯¹æ¯”æ€»ç»“
======================================================================
âœ… æ‰€æœ‰å­—æ®µéƒ½åŒ¹é…ï¼ç¦»çº¿æ¨ç†å’Œå®æ—¶æ¨ç†çš„observationè¾“å…¥ä¸€è‡´ã€‚
   å®æ—¶æ¨ç†çš„è¾“å…¥å¤„ç†æ˜¯æ­£ç¡®çš„ã€‚
======================================================================

âœ… æ¨¡å‹é¢„æµ‹ç»“æœä¹ŸåŒ¹é…ï¼è¯´æ˜æ•´ä¸ªpipelineä¸€è‡´ã€‚
```

âŒ **å¦‚æœä»ç„¶å¤±è´¥**ï¼š
- æ£€æŸ¥å›¾åƒçš„ç»Ÿè®¡ä¿¡æ¯ï¼ˆMin, Max, Mean, Stdï¼‰
- ç¦»çº¿å’Œå®æ—¶çš„æ•°å€¼èŒƒå›´åº”è¯¥ç›¸åŒ
- å¦‚æœçœ‹åˆ° "VALUES DIFFER"ï¼Œè¯´æ˜è¿˜æœ‰é—®é¢˜éœ€è¦è¿›ä¸€æ­¥è°ƒè¯•

---

### æ–¹æ³•2ï¼šå®é™…è¿è¡Œå®æ—¶æ¨ç†

```bash
cd /home/ren9/DualArm/openpi

uv run examples/realman_inference.py \
    --config-name pi0_realman \
    --checkpoint /home/ren9/DualArm/openpi/checkpoints/pi0_realman/realman_finetune_v1/14999/params \
    --norm-stats /home/ren9/DualArm/openpi/assets/pi0_realman/realman_dataset/ \
    --output inference_actions.csv \
    --speed 20 \
    --steps-to-execute 3
```

#### é¢„æœŸæ”¹å–„

âœ… **è½¨è¿¹è´¨é‡**ï¼š
- æœºæ¢°è‡‚åº”è¯¥æ²¿ç€æ­£ç¡®çš„Så½¢è·¯å¾„è¿åŠ¨
- è¿åŠ¨åº”è¯¥å¹³æ»‘ä¸”ç¬¦åˆè®­ç»ƒæ•°æ®çš„è¡Œä¸º
- ä¸åº”è¯¥å‡ºç°çªç„¶çš„è·³å˜æˆ–å¼‚å¸¸åŠ¨ä½œ

âœ… **æ¨ç†é¢‘ç‡**ï¼š
- åˆ é™¤äº†ä¸å¿…è¦çš„å½’ä¸€åŒ–è®¡ç®—
- ä¿æŒuint8æ ¼å¼å‡å°‘äº†å†…å­˜å ç”¨
- é¢‘ç‡åº”è¯¥ä» ~0.14Hz æå‡ï¼ˆå…·ä½“æå‡å¹…åº¦å–å†³äºç¡¬ä»¶ï¼‰

âœ… **æ•°å€¼ç¨³å®šæ€§**ï¼š
- åŠ¨ä½œé¢„æµ‹åº”è¯¥æ›´åŠ ç¨³å®š
- ä¸ä¼šå‡ºç°å¼‚å¸¸çš„å¤§å¹…åº¦åŠ¨ä½œ

---

## ğŸ” è°ƒè¯•æ£€æŸ¥ç‚¹

å¦‚æœé—®é¢˜ä»ç„¶å­˜åœ¨ï¼ŒæŒ‰ç…§ä»¥ä¸‹é¡ºåºæ£€æŸ¥ï¼š

### 1. æ£€æŸ¥å›¾åƒæ•°æ®æ ¼å¼
åœ¨ `realman_inference.py` ä¸­æ·»åŠ ä¸´æ—¶æ‰“å°ï¼š

```python
# åœ¨ _get_current_state() å‡½æ•°ä¸­ï¼Œé¢„å¤„ç†å
cam_high_processed = preprocess_image(cam_high_img)
print(f"Image after preprocess: dtype={cam_high_processed.dtype}, "
      f"shape={cam_high_processed.shape}, "
      f"min={cam_high_processed.min()}, max={cam_high_processed.max()}")
```

é¢„æœŸè¾“å‡ºï¼š
```
Image after preprocess: dtype=uint8, shape=(3, 224, 224), min=0, max=255
```

### 2. æ£€æŸ¥transformåçš„æ•°æ®
```python
# åœ¨ _run_inference() å‡½æ•°ä¸­ï¼Œtransformå
transformed = self.input_transform(state_dict)
print(f"Image after transform: dtype={transformed['observation.images.cam_high'].dtype}, "
      f"min={transformed['observation.images.cam_high'].min()}, "
      f"max={transformed['observation.images.cam_high'].max()}")
```

é¢„æœŸè¾“å‡ºï¼šåº”è¯¥ä¸ç¦»çº¿æ¨ç†çš„transformç»“æœèŒƒå›´ä¸€è‡´

### 3. æ£€æŸ¥å½’ä¸€åŒ–ç»Ÿè®¡
```python
# æ£€æŸ¥norm_statsæ˜¯å¦æ­£ç¡®åŠ è½½
print("Norm stats keys:", self.norm_stats.keys())
if 'observation.images.cam_high' in self.norm_stats:
    stats = self.norm_stats['observation.images.cam_high']
    print(f"Image norm stats: mean={stats.mean}, std={stats.std}")
```

---

## ğŸ“Š å¯¹æ¯”ï¼šä¿®å¤å‰åçš„å·®å¼‚

### å›¾åƒå¤„ç†æµç¨‹

| æ­¥éª¤ | ä¿®å¤å‰ | ä¿®å¤å |
|------|--------|--------|
| 1. åŸå§‹æ•°æ® | uint8 [0,255] BGR | uint8 [0,255] BGR |
| 2. preprocess_image | float32 [-1,1] RGB CHW âŒ | uint8 [0,255] RGB CHW âœ… |
| 3. transform pipeline | å†æ¬¡å½’ä¸€åŒ– âŒ | å½’ä¸€åŒ– âœ… |
| 4. æœ€ç»ˆè¾“å…¥ | é”™è¯¯çš„æ•°å€¼åˆ†å¸ƒ âŒ | æ­£ç¡®çš„æ•°å€¼åˆ†å¸ƒ âœ… |

### æ•°å€¼ç¤ºä¾‹

å‡è®¾åŸå§‹åƒç´ å€¼ä¸º 128ï¼ˆä¸­ç°ï¼‰ï¼š

**ä¿®å¤å‰ï¼ˆé”™è¯¯ï¼‰**ï¼š
```
128 (uint8) 
â†’ (128/127.5)-1 = 0.004 (float32) [preprocess]
â†’ Normalize(mean, std) â†’ é”™è¯¯çš„å½’ä¸€åŒ–å€¼ âŒ
```

**ä¿®å¤åï¼ˆæ­£ç¡®ï¼‰**ï¼š
```
128 (uint8)
â†’ 128 (uint8) [preprocessï¼Œä¸åšå½’ä¸€åŒ–]
â†’ Normalize(mean, std) â†’ æ­£ç¡®çš„å½’ä¸€åŒ–å€¼ âœ…
```

---

## ğŸ¯ é¢„æœŸç»“æœæ€»ç»“

| æŒ‡æ ‡ | ä¿®å¤å‰ | ä¿®å¤å |
|------|--------|--------|
| è½¨è¿¹å‡†ç¡®æ€§ | âŒ é”™è¯¯çš„Sè½¨è¿¹ | âœ… æ­£ç¡®çš„Sè½¨è¿¹ |
| è¾“å…¥ä¸€è‡´æ€§ | âŒ ä¸è®­ç»ƒæ•°æ®ä¸åŒ¹é… | âœ… ä¸è®­ç»ƒæ•°æ®ä¸€è‡´ |
| æ¨ç†é¢‘ç‡ | ~0.14Hz | é¢„æœŸæå‡ |
| æ•°å€¼ç¨³å®šæ€§ | âŒ ä¸ç¨³å®š | âœ… ç¨³å®š |

---

## ğŸ“ å¦‚éœ€å¸®åŠ©

å¦‚æœéªŒè¯å¤±è´¥æˆ–é‡åˆ°æ–°é—®é¢˜ï¼š

1. é¦–å…ˆè¿è¡Œå¯¹æ¯”å·¥å…·ï¼ŒæŸ¥çœ‹è¯¦ç»†çš„æ•°å€¼å¯¹æ¯”
2. æ£€æŸ¥ä¸Šè¿°è°ƒè¯•æ£€æŸ¥ç‚¹
3. ç¡®è®¤ä½¿ç”¨çš„æ˜¯æ­£ç¡®çš„å½’ä¸€åŒ–ç»Ÿè®¡æ–‡ä»¶
4. æ£€æŸ¥æ•°æ®é›†å’Œcheckpointæ˜¯å¦åŒ¹é…

---

**ä¿®å¤æ—¥æœŸ**ï¼š2025-11-17  
**ç›¸å…³æ–‡æ¡£**ï¼š`REALMAN_INFERENCE_FIX_SUMMARY.md`

